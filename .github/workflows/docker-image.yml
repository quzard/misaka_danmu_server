# .github/workflows/docker-publish.yml
name: Publish to Docker Hub & GitHub Packages

# 触发条件：
# 1. 当推送到 'test' 分支时
# 2. 当推送到 'beta' 分支时
# 3. 当创建 'v*.*.*' 格式的标签时
on:
  push:
    branches:
      - "test"
    tags:
      - "v*.*.*"

env:
  DOCKERHUB_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/misaka_danmu_server

jobs:
  # 准备构建参数
  prepare:
    runs-on: ubuntu-latest
    outputs:
      so_tag: ${{ steps.prep.outputs.so_tag }}
      image_tag: ${{ steps.prep.outputs.image_tag }}
      extra_tags: ${{ steps.prep.outputs.extra_tags }}
      build_arm: ${{ steps.prep.outputs.build_arm }}
      ghcr_image: ${{ steps.prep.outputs.ghcr_image }}
    steps:
      - name: Prepare build parameters
        id: prep
        run: |
          GHCR_IMAGE=ghcr.io/${{ github.repository_owner }}/misaka_danmu_server
          GHCR_IMAGE=${GHCR_IMAGE,,}
          echo "ghcr_image=${GHCR_IMAGE}" >> $GITHUB_OUTPUT

          # 默认值
          SO_TAG="latest"
          BUILD_ARM="true"
          EXTRA_TAGS=""

          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
            echo "image_tag=${TAG}" >> $GITHUB_OUTPUT
            EXTRA_TAGS="latest"
          elif [[ $GITHUB_REF == refs/heads/test ]]; then
            echo "image_tag=test" >> $GITHUB_OUTPUT
            SO_TAG="test"
            BUILD_ARM="false"
          elif [[ $GITHUB_REF == refs/heads/beta ]]; then
            echo "image_tag=beta" >> $GITHUB_OUTPUT
          fi

          echo "so_tag=${SO_TAG}" >> $GITHUB_OUTPUT
          echo "build_arm=${BUILD_ARM}" >> $GITHUB_OUTPUT
          echo "extra_tags=${EXTRA_TAGS}" >> $GITHUB_OUTPUT

  # 构建 AMD64 镜像
  build-amd64:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push AMD64 image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.DOCKERHUB_IMAGE }}:${{ needs.prepare.outputs.image_tag }}-amd64
            ${{ needs.prepare.outputs.ghcr_image }}:${{ needs.prepare.outputs.image_tag }}-amd64
          build-args: |
            SO_TAG=${{ needs.prepare.outputs.so_tag }}
          secrets: |
            XOR_KEY_SECRET=${{ secrets.XOR_KEY_SECRET }}

  # 构建 ARM64 镜像（使用原生 ARM runner）
  build-arm64:
    needs: prepare
    if: needs.prepare.outputs.build_arm == 'true'
    runs-on: ubuntu-latest-arm
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ARM64 image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.DOCKERHUB_IMAGE }}:${{ needs.prepare.outputs.image_tag }}-arm64
            ${{ needs.prepare.outputs.ghcr_image }}:${{ needs.prepare.outputs.image_tag }}-arm64
          build-args: |
            SO_TAG=${{ needs.prepare.outputs.so_tag }}
          secrets: |
            XOR_KEY_SECRET=${{ secrets.XOR_KEY_SECRET }}

  # 创建多架构 manifest
  create-manifest:
    needs: [prepare, build-amd64, build-arm64]
    if: always() && needs.build-amd64.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifest (multi-arch)
        run: |
          TAG="${{ needs.prepare.outputs.image_tag }}"
          DOCKERHUB_IMAGE="${{ env.DOCKERHUB_IMAGE }}"
          GHCR_IMAGE="${{ needs.prepare.outputs.ghcr_image }}"
          BUILD_ARM="${{ needs.prepare.outputs.build_arm }}"
          EXTRA_TAGS="${{ needs.prepare.outputs.extra_tags }}"

          # 根据是否构建了 ARM 来决定 manifest 内容
          if [[ "$BUILD_ARM" == "true" && "${{ needs.build-arm64.result }}" == "success" ]]; then
            # 多架构 manifest
            docker buildx imagetools create -t ${DOCKERHUB_IMAGE}:${TAG} \
              ${DOCKERHUB_IMAGE}:${TAG}-amd64 \
              ${DOCKERHUB_IMAGE}:${TAG}-arm64

            docker buildx imagetools create -t ${GHCR_IMAGE}:${TAG} \
              ${GHCR_IMAGE}:${TAG}-amd64 \
              ${GHCR_IMAGE}:${TAG}-arm64

            # 额外标签（如 latest）
            if [[ -n "$EXTRA_TAGS" ]]; then
              for EXTRA_TAG in $EXTRA_TAGS; do
                docker buildx imagetools create -t ${DOCKERHUB_IMAGE}:${EXTRA_TAG} \
                  ${DOCKERHUB_IMAGE}:${TAG}-amd64 \
                  ${DOCKERHUB_IMAGE}:${TAG}-arm64

                docker buildx imagetools create -t ${GHCR_IMAGE}:${EXTRA_TAG} \
                  ${GHCR_IMAGE}:${TAG}-amd64 \
                  ${GHCR_IMAGE}:${TAG}-arm64
              done
            fi
          else
            # 仅 AMD64
            docker buildx imagetools create -t ${DOCKERHUB_IMAGE}:${TAG} \
              ${DOCKERHUB_IMAGE}:${TAG}-amd64

            docker buildx imagetools create -t ${GHCR_IMAGE}:${TAG} \
              ${GHCR_IMAGE}:${TAG}-amd64
          fi
