# =============================================================================
# Docker å¤šæ¶æ„é•œåƒæ„å»ºå·¥ä½œæµ
# =============================================================================
# åŠŸèƒ½ï¼šæ„å»º AMD64 å’Œ ARM64 åŒæ¶æ„ Docker é•œåƒï¼Œæ¨é€åˆ° Docker Hub å’Œ GHCR
# æ¶æ„ï¼šé‡‡ç”¨å¹¶è¡Œæ„å»º + manifest åˆå¹¶çš„æ–¹å¼
#
# æ„å»ºæµç¨‹ï¼š
#   prepare â”€â”€â”¬â”€â”€> build-amd64 â”€â”€â”¬â”€â”€> create-manifest
#             â”‚                  â”‚
#             â””â”€â”€> build-arm64 â”€â”€â”˜
#
# åˆ†æ”¯/æ ‡ç­¾ç­–ç•¥ï¼š
#   - test åˆ†æ”¯ï¼šä»…æ„å»º AMD64ï¼Œä½¿ç”¨ test æ ‡ç­¾çš„ .so æ–‡ä»¶
#   - v*.*.* æ ‡ç­¾ï¼šæ„å»ºåŒæ¶æ„ï¼ŒåŒæ—¶æ‰“ version å’Œ latest æ ‡ç­¾
# =============================================================================

name: Publish to Docker Hub & GitHub Packages

# -----------------------------------------------------------------------------
# è§¦å‘æ¡ä»¶
# -----------------------------------------------------------------------------
on:
  push:
    branches:
      - main
      - "test"       # test åˆ†æ”¯ï¼šä»…æ„å»º AMD64 ç”¨äºæµ‹è¯•
    tags:
      - "v*.*.*"     # ç‰ˆæœ¬æ ‡ç­¾ï¼šæ„å»ºåŒæ¶æ„æ­£å¼ç‰ˆ

# -----------------------------------------------------------------------------
# å…¨å±€ç¯å¢ƒå˜é‡
# -----------------------------------------------------------------------------
env:
  # Docker Hub é•œåƒåœ°å€
  DOCKERHUB_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/misaka_danmu_server
  # GitHub Container Registry é•œåƒåœ°å€
  GHCR_IMAGE: ghcr.io/${{ github.repository_owner }}/misaka_danmu_server

# =============================================================================
# Jobs å®šä¹‰
# =============================================================================
jobs:

  # ---------------------------------------------------------------------------
  # Job 1: å‡†å¤‡æ„å»ºå‚æ•°
  # ---------------------------------------------------------------------------
  # æ ¹æ®è§¦å‘äº‹ä»¶ï¼ˆåˆ†æ”¯/æ ‡ç­¾ï¼‰ç¡®å®šæ„å»ºå‚æ•°
  # ---------------------------------------------------------------------------
  prepare:
    name: ğŸ“‹ å‡†å¤‡æ„å»ºå‚æ•°
    runs-on: ubuntu-latest
    outputs:
      so_tag: ${{ steps.prep.outputs.so_tag }}           # .so æ–‡ä»¶æ ‡ç­¾
      image_tag: ${{ steps.prep.outputs.image_tag }}     # Docker é•œåƒæ ‡ç­¾
      extra_tags: ${{ steps.prep.outputs.extra_tags }}   # é¢å¤–æ ‡ç­¾ï¼ˆå¦‚ latestï¼‰
      build_arm: ${{ steps.prep.outputs.build_arm }}     # æ˜¯å¦æ„å»º ARM64
    steps:
      - name: è§£ææ„å»ºå‚æ•°
        id: prep
        run: |
          # é»˜è®¤å€¼
          SO_TAG="latest"      # é»˜è®¤ä½¿ç”¨ latest æ ‡ç­¾çš„ .so æ–‡ä»¶
          BUILD_ARM="true"     # é»˜è®¤æ„å»º ARM64
          EXTRA_TAGS=""        # é»˜è®¤æ— é¢å¤–æ ‡ç­¾

          # æ ¹æ®è§¦å‘äº‹ä»¶è®¾ç½®å‚æ•°
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            # ç‰ˆæœ¬æ ‡ç­¾è§¦å‘ï¼šæå–ç‰ˆæœ¬å·ï¼ŒåŒæ—¶æ‰“ latest æ ‡ç­¾
            TAG=${GITHUB_REF#refs/tags/}
            echo "image_tag=${TAG}" >> $GITHUB_OUTPUT
            EXTRA_TAGS="latest"
          elif [[ $GITHUB_REF == refs/heads/test ]]; then
            # test åˆ†æ”¯è§¦å‘ï¼šä»…æ„å»º AMD64ï¼Œä½¿ç”¨ test æ ‡ç­¾çš„ .so æ–‡ä»¶
            echo "image_tag=test" >> $GITHUB_OUTPUT
            SO_TAG="test"
            BUILD_ARM="false"
          fi

          echo "so_tag=${SO_TAG}" >> $GITHUB_OUTPUT
          echo "build_arm=${BUILD_ARM}" >> $GITHUB_OUTPUT
          echo "extra_tags=${EXTRA_TAGS}" >> $GITHUB_OUTPUT

  # ---------------------------------------------------------------------------
  # Job 2: æ„å»º AMD64 é•œåƒ
  # ---------------------------------------------------------------------------
  # åœ¨ ubuntu-latest (x86_64) ä¸ŠåŸç”Ÿæ„å»º AMD64 é•œåƒ
  # ---------------------------------------------------------------------------
  build-amd64:
    name: ğŸ”¨ æ„å»º AMD64
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: è®¾ç½® Docker Buildx
      # Buildx æ˜¯ Docker çš„æ‰©å±•æ„å»ºå·¥å…·ï¼Œæ”¯æŒå¤šå¹³å°æ„å»º
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      # æ­¥éª¤ 3: ç™»å½• Docker Hub
      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # æ­¥éª¤ 4: ç™»å½• GitHub Container Registry
      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤ 5: æ„å»ºå¹¶æ¨é€ AMD64 é•œåƒ
      - name: æ„å»ºå¹¶æ¨é€ AMD64 é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.DOCKERHUB_IMAGE }}:${{ needs.prepare.outputs.image_tag }}-amd64
            ${{ env.GHCR_IMAGE }}:${{ needs.prepare.outputs.image_tag }}-amd64
          build-args: |
            SO_TAG=${{ needs.prepare.outputs.so_tag }}
          secrets: |
            XOR_KEY_SECRET=${{ secrets.XOR_KEY_SECRET }}

  # ---------------------------------------------------------------------------
  # Job 3: æ„å»º ARM64 é•œåƒ
  # ---------------------------------------------------------------------------
  # ä½¿ç”¨ QEMU æ¨¡æ‹Ÿåœ¨ ubuntu-latest ä¸Šæ„å»º ARM64 é•œåƒ
  # ä¸ build-amd64 å¹¶è¡Œæ‰§è¡Œï¼Œæé«˜æ„å»ºæ•ˆç‡
  # ---------------------------------------------------------------------------
  build-arm64:
    name: ğŸ”¨ æ„å»º ARM64
    needs: prepare
    # ä»…å½“ build_arm ä¸º true æ—¶æ‰§è¡Œï¼ˆtest åˆ†æ”¯è·³è¿‡ï¼‰
    if: needs.prepare.outputs.build_arm == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: è®¾ç½® QEMU æ¨¡æ‹Ÿå™¨
      # QEMU å…è®¸åœ¨ x86_64 æœºå™¨ä¸Šæ¨¡æ‹Ÿ ARM64 æ¶æ„è¿›è¡Œæ„å»º
      # è™½ç„¶æ¯”åŸç”Ÿ ARM runner æ…¢ï¼Œä½†ä¸éœ€è¦ç‰¹æ®Šçš„ runner
      - name: è®¾ç½® QEMU æ¨¡æ‹Ÿå™¨
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      # æ­¥éª¤ 3: è®¾ç½® Docker Buildx
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      # æ­¥éª¤ 4: ç™»å½• Docker Hub
      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # æ­¥éª¤ 5: ç™»å½• GitHub Container Registry
      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤ 6: æ„å»ºå¹¶æ¨é€ ARM64 é•œåƒ
      - name: æ„å»ºå¹¶æ¨é€ ARM64 é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.DOCKERHUB_IMAGE }}:${{ needs.prepare.outputs.image_tag }}-arm64
            ${{ env.GHCR_IMAGE }}:${{ needs.prepare.outputs.image_tag }}-arm64
          build-args: |
            SO_TAG=${{ needs.prepare.outputs.so_tag }}
          secrets: |
            XOR_KEY_SECRET=${{ secrets.XOR_KEY_SECRET }}

  # ---------------------------------------------------------------------------
  # Job 4: åˆ›å»ºå¤šæ¶æ„ Manifest
  # ---------------------------------------------------------------------------
  # å°† AMD64 å’Œ ARM64 é•œåƒåˆå¹¶ä¸ºä¸€ä¸ªå¤šæ¶æ„é•œåƒ
  # Docker ä¼šæ ¹æ®æ‹‰å–æ—¶çš„å¹³å°è‡ªåŠ¨é€‰æ‹©å¯¹åº”æ¶æ„çš„é•œåƒ
  # ---------------------------------------------------------------------------
  create-manifest:
    name: ğŸ“¦ åˆ›å»ºå¤šæ¶æ„ Manifest
    needs: [prepare, build-amd64, build-arm64]
    # always() ç¡®ä¿å³ä½¿ build-arm64 è¢«è·³è¿‡ä¹Ÿä¼šæ‰§è¡Œ
    # ä½†è¦æ±‚ build-amd64 å¿…é¡»æˆåŠŸ
    if: always() && needs.build-amd64.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      # æ­¥éª¤ 1: ç™»å½• Docker Hub
      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # æ­¥éª¤ 2: ç™»å½• GitHub Container Registry
      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤ 3: åˆ›å»ºå¹¶æ¨é€å¤šæ¶æ„ manifest
      - name: åˆ›å»ºå¹¶æ¨é€å¤šæ¶æ„ Manifest
        run: |
          TAG="${{ needs.prepare.outputs.image_tag }}"
          DOCKERHUB_IMAGE="${{ env.DOCKERHUB_IMAGE }}"
          GHCR_IMAGE="${{ env.GHCR_IMAGE }}"
          BUILD_ARM="${{ needs.prepare.outputs.build_arm }}"
          EXTRA_TAGS="${{ needs.prepare.outputs.extra_tags }}"

          # æ ¹æ®æ˜¯å¦æ„å»ºäº† ARM æ¥å†³å®š manifest å†…å®¹
          if [[ "$BUILD_ARM" == "true" && "${{ needs.build-arm64.result }}" == "success" ]]; then
            echo "ğŸ“¦ åˆ›å»ºåŒæ¶æ„ manifest..."

            # åˆ›å»ºä¸»æ ‡ç­¾çš„å¤šæ¶æ„ manifest
            docker buildx imagetools create -t ${DOCKERHUB_IMAGE}:${TAG} \
              ${DOCKERHUB_IMAGE}:${TAG}-amd64 \
              ${DOCKERHUB_IMAGE}:${TAG}-arm64

            docker buildx imagetools create -t ${GHCR_IMAGE}:${TAG} \
              ${GHCR_IMAGE}:${TAG}-amd64 \
              ${GHCR_IMAGE}:${TAG}-arm64

            # åˆ›å»ºé¢å¤–æ ‡ç­¾ï¼ˆå¦‚ latestï¼‰çš„å¤šæ¶æ„ manifest
            if [[ -n "$EXTRA_TAGS" ]]; then
              for EXTRA_TAG in $EXTRA_TAGS; do
                echo "ğŸ“¦ åˆ›å»º ${EXTRA_TAG} æ ‡ç­¾..."
                docker buildx imagetools create -t ${DOCKERHUB_IMAGE}:${EXTRA_TAG} \
                  ${DOCKERHUB_IMAGE}:${TAG}-amd64 \
                  ${DOCKERHUB_IMAGE}:${TAG}-arm64

                docker buildx imagetools create -t ${GHCR_IMAGE}:${EXTRA_TAG} \
                  ${GHCR_IMAGE}:${TAG}-amd64 \
                  ${GHCR_IMAGE}:${TAG}-arm64
              done
            fi
          else
            echo "ğŸ“¦ åˆ›å»ºå•æ¶æ„ manifest (ä»… AMD64)..."

            # ä»… AMD64 çš„ manifest
            docker buildx imagetools create -t ${DOCKERHUB_IMAGE}:${TAG} \
              ${DOCKERHUB_IMAGE}:${TAG}-amd64

            docker buildx imagetools create -t ${GHCR_IMAGE}:${TAG} \
              ${GHCR_IMAGE}:${TAG}-amd64
          fi

          echo "âœ… Manifest åˆ›å»ºå®Œæˆï¼"
