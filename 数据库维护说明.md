# 数据库维护与Binlog清理说明

本文档旨在说明“数据库维护”定时任务，特别是其中涉及的 MySQL Binlog 清理功能，以及如何处理相关的权限警告。

## 1. 背景

应用新增了一个名为 **“数据库维护”** 类型的定时任务，其主要功能包括：
- 清理过期的应用日志（如任务历史、API访问记录等）。
- **（仅限MySQL）** 清理旧的二进制日志（Binary Log，简称 Binlog），以防止其无限增长，占用过多磁盘空间。
- 优化数据库表，保持数据库健康。

## 2. 关于 "Binlog 清理失败" 警告

在使用 MySQL 数据库时，你可能会在日志中看到类似以下的警告信息：

```
[ERROR] - Binlog 清理失败: (pymysql.err.OperationalError) (1227, 'Access denied; you need (at least one of) the SUPER or BINLOG_ADMIN privilege(s) for this operation')
```

**请注意：这是一个常见且可安全忽略的警告，不是一个严重错误。**

- **原因**：执行 `PURGE BINARY LOGS` 命令需要较高的数据库权限（`SUPER` 或 `BINLOG_ADMIN`）。出于安全考虑，默认创建的数据库用户 `danmuapi` 并没有这些高级权限。
- **影响**：当出现此警告时，仅表示“清理Binlog”这一步操作被跳过。应用的**所有核心功能（搜索、导入、匹配弹幕等）均不受任何影响**。
- **处理**：应用内部已对该特定错误进行了处理，只会记录一条警告信息，不会导致任务失败或产生大量错误日志。

## 3. 如何开启Binlog自动清理（可选）

如果你希望开启此功能，以自动管理数据库磁盘空间，可以手动为应用数据库用户授予所需权限。

**此操作仅适用于已经部署并正在使用 MySQL 数据库的用户。** 对于新用户，可以在初始化数据库后执行此操作。

1.  进入你的 MySQL 数据库。如果使用 Docker，可以执行以下命令进入容器内的 MySQL 命令行：
    ```bash
    docker exec -it <你的MySQL容器名称或ID> mysql -u root -p
    ```
    然后输入你的 `DB_ROOT_PASSWORD`。

2.  在 MySQL 命令行中，执行以下授权命令。请将 `'danmuapi'@'%'` 中的 `danmuapi` 替换为你的实际数据库用户名（如果你修改过的话）。
    ```sql
    GRANT BINLOG_ADMIN ON *.* TO 'danmuapi'@'%';
    FLUSH PRIVILEGES;
    ```

3.  完成授权后，下一次“数据库维护”任务运行时，将不再出现此警告，并会成功清理旧的Binlog文件。

## 4. PostgreSQL 用户

此说明仅针对 MySQL 数据库。PostgreSQL 用户没有 Binlog 机制，因此不会遇到此问题。

