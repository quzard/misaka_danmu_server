# ğŸš€ å¿«é€Ÿå¼€å§‹ (ä½¿ç”¨ Docker Compose)

æ¨èä½¿ç”¨ Docker å’Œ Docker Compose è¿›è¡Œä¸€é”®éƒ¨ç½²ã€‚

## æ­¥éª¤ 1: å‡†å¤‡ `docker-compose.yaml`

1.  åœ¨ä¸€ä¸ªåˆé€‚çš„ç›®å½•ï¼ˆä¾‹å¦‚ `~/danmuku`ï¼‰ä¸‹ï¼Œåˆ›å»º `docker-compose.yaml` æ–‡ä»¶å’Œæ‰€éœ€çš„æ–‡ä»¶å¤¹ `configï¼Œdb-data`ã€‚

    ```bash
    mkdir -p ~/danmuku
    cd ~/danmuku
    mkdir -p db-data config
    touch docker-compose.yaml
    ```

2.  æ ¹æ®æ‚¨é€‰æ‹©çš„æ•°æ®åº“ï¼Œå°†ä»¥ä¸‹å†…å®¹ä¹‹ä¸€å¤åˆ¶åˆ° `docker-compose.yaml` æ–‡ä»¶ä¸­ã€‚

### æ–¹æ¡ˆ A: ä½¿ç”¨ MySQL (æ¨è)

```yaml
version: "3.8"
services:
  mysql:
    image: mysql:8.1.0-oracle
    container_name: danmu-mysql
    restart: unless-stopped
    environment:
      # !!! é‡è¦ï¼šè¯·åŠ¡å¿…æ›¿æ¢ä¸ºæ‚¨çš„å¼ºå¯†ç  !!!
      MYSQL_ROOT_PASSWORD: "your_strong_root_password"                  #æ•°æ®åº“rootå¯†ç 
      MYSQL_DATABASE: "danmuapi"                                        #æ•°æ®åº“åç§°
      MYSQL_USER: "danmuapi"                                            #æ•°æ®åº“ç”¨æˆ·å
      MYSQL_PASSWORD: "your_strong_user_password"                       #æ•°æ®åº“å¯†ç 
      TZ: "Asia/Shanghai"
    volumes:
      - ./db-data:/var/lib/mysql
    command:
      - '--character-set-server=utf8mb4'
      - '--collation-server=utf8mb4_unicode_ci'
      - '--binlog_expire_logs_seconds=259200' # è‡ªåŠ¨æ¸…ç†è¶…è¿‡3å¤©çš„binlogæ—¥å¿—
      - '--default-authentication-plugin=mysql_native_password' # ä½¿ç”¨ä¼ ç»Ÿå¯†ç è®¤è¯æ–¹å¼
    healthcheck:
      # ä½¿ç”¨mysqladmin pingå‘½ä»¤è¿›è¡Œå¥åº·æ£€æŸ¥ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡å¼•ç”¨å¯†ç 
      test: ["CMD-SHELL", "mysqladmin ping -u$${MYSQL_USER} -p$${MYSQL_PASSWORD}"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 30s

    networks:
      - misaka-net

  danmu-app:
    image: l429609201/misaka_danmu_server:latest
    container_name: misaka-danmu-server
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      # è®¾ç½®è¿è¡Œå®¹å™¨çš„ç”¨æˆ·å’Œç»„IDï¼Œä»¥åŒ¹é…æ‚¨å®¿ä¸»æœºçš„ç”¨æˆ·ï¼Œé¿å…æŒ‚è½½å·çš„æƒé™é—®é¢˜ã€‚
      - PUID=1000
      - PGID=1000
      - UMASK=0022
      - TZ=Asia/Shanghai
      # --- æ•°æ®åº“è¿æ¥é…ç½® ---
      - DANMUAPI_DATABASE__TYPE=mysql                         # æ•°æ®åº“ç±»å‹
      - DANMUAPI_DATABASE__HOST=mysql                         # ä½¿ç”¨æœåŠ¡å
      - DANMUAPI_DATABASE__PORT=3306                          # ç«¯å£å·
      - DANMUAPI_DATABASE__NAME=danmuapi                      # æ•°æ®åº“åç§°
      # !!! é‡è¦ï¼šè¯·ä½¿ç”¨ä¸Šé¢mysqlå®¹å™¨ç›¸åŒçš„ç”¨æˆ·åå’Œå¯†ç  !!!
      - DANMUAPI_DATABASE__USER=danmuapi                      #æ•°æ®åº“ç”¨æˆ·å
      - DANMUAPI_DATABASE__PASSWORD=your_strong_user_password #æ•°æ®åº“å¯†ç 
      # --- åˆå§‹ç®¡ç†å‘˜é…ç½® ---
      - DANMUAPI_ADMIN__INITIAL_USER=admin
    volumes:
      - ./config:/app/config
    ports:
      - "7768:7768"
    networks:
      - misaka-net

networks:
  misaka-net:
    driver: bridge
```

### æ–¹æ¡ˆ A-2: ä½¿ç”¨ MySQL (å°å†…å­˜æ¨¡å¼)

> ğŸ’¡ **é€‚ç”¨åœºæ™¯**: é€‚åˆå†…å­˜æœ‰é™çš„ VPS (å¦‚ 512MB-1GB),é€šè¿‡ä¼˜åŒ– MySQL é…ç½®å‡å°‘å†…å­˜å ç”¨ã€‚

```yaml
version: "3.8"
services:
  mysql:
    image: mysql:8.1.0-oracle
    container_name: danmu-mysql
    restart: unless-stopped
    environment:
      # !!! é‡è¦ï¼šè¯·åŠ¡å¿…æ›¿æ¢ä¸ºæ‚¨çš„å¼ºå¯†ç  !!!
      MYSQL_ROOT_PASSWORD: "your_strong_root_password"                  #æ•°æ®åº“rootå¯†ç 
      MYSQL_DATABASE: "danmuapi"                                        #æ•°æ®åº“åç§°
      MYSQL_USER: "danmuapi"                                            #æ•°æ®åº“ç”¨æˆ·å
      MYSQL_PASSWORD: "your_strong_user_password"                       #æ•°æ®åº“å¯†ç 
      TZ: "Asia/Shanghai"
    volumes:
      - ./db-data:/var/lib/mysql
    command:
      - '--character-set-server=utf8mb4'
      - '--collation-server=utf8mb4_unicode_ci'
      - '--binlog_expire_logs_seconds=259200'
      - '--default-authentication-plugin=mysql_native_password'
      # --- å°å†…å­˜ä¼˜åŒ–é…ç½® ---
      - '--innodb_buffer_pool_size=128M'           # InnoDBç¼“å†²æ± å¤§å° (é»˜è®¤128M,å¯æ ¹æ®å†…å­˜è°ƒæ•´)
      - '--innodb_log_file_size=32M'               # æ—¥å¿—æ–‡ä»¶å¤§å°
      - '--innodb_log_buffer_size=8M'              # æ—¥å¿—ç¼“å†²åŒºå¤§å°
      - '--max_connections=50'                     # æœ€å¤§è¿æ¥æ•° (é»˜è®¤151,å‡å°‘åˆ°50)
      - '--table_open_cache=64'                    # è¡¨ç¼“å­˜ (é»˜è®¤4000,å‡å°‘åˆ°64)
      - '--performance_schema=OFF'                 # å…³é—­æ€§èƒ½ç›‘æ§ (èŠ‚çœå†…å­˜)
      - '--innodb_flush_log_at_trx_commit=2'       # æ—¥å¿—åˆ·æ–°ç­–ç•¥ (æå‡æ€§èƒ½,ç•¥é™å®‰å…¨æ€§)
      - '--innodb_flush_method=O_DIRECT'           # ç»•è¿‡æ“ä½œç³»ç»Ÿç¼“å­˜
      - '--query_cache_size=0'                     # ç¦ç”¨æŸ¥è¯¢ç¼“å­˜ (MySQL 8.0å·²åºŸå¼ƒ)
      - '--query_cache_type=0'                     # ç¦ç”¨æŸ¥è¯¢ç¼“å­˜ç±»å‹
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -u$${MYSQL_USER} -p$${MYSQL_PASSWORD}"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 30s
    networks:
      - misaka-net

  danmu-app:
    image: l429609201/misaka_danmu_server:latest
    container_name: misaka-danmu-server
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - UMASK=0022
      - TZ=Asia/Shanghai
      # --- æ•°æ®åº“è¿æ¥é…ç½® ---
      - DANMUAPI_DATABASE__TYPE=mysql
      - DANMUAPI_DATABASE__HOST=mysql
      - DANMUAPI_DATABASE__PORT=3306
      - DANMUAPI_DATABASE__NAME=danmuapi
      # !!! é‡è¦ï¼šè¯·ä½¿ç”¨ä¸Šé¢mysqlå®¹å™¨ç›¸åŒçš„ç”¨æˆ·åå’Œå¯†ç  !!!
      - DANMUAPI_DATABASE__USER=danmuapi
      - DANMUAPI_DATABASE__PASSWORD=your_strong_user_password
      # --- åˆå§‹ç®¡ç†å‘˜é…ç½® ---
      - DANMUAPI_ADMIN__INITIAL_USER=admin
    volumes:
      - ./config:/app/config
    ports:
      - "7768:7768"
    networks:
      - misaka-net

networks:
  misaka-net:
    driver: bridge
```


### æ–¹æ¡ˆ B: ä½¿ç”¨ PostgreSQL (å¯é€‰)

```yaml
version: "3.8"
services:
  postgres:
    image: postgres:16
    container_name: danmu-postgres
    restart: unless-stopped
    environment:
      # !!! é‡è¦ï¼šè¯·åŠ¡å¿…æ›¿æ¢ä¸ºæ‚¨çš„å¼ºå¯†ç  !!!
      POSTGRES_PASSWORD: "your_strong_postgres_password"               #æ•°æ®åº“å¯†ç 
      POSTGRES_USER: "danmuapi"                                        #æ•°æ®åº“ç”¨æˆ·å
      POSTGRES_DB: "danmuapi"                                          #æ•°æ®åº“åç§°
      TZ: "Asia/Shanghai"
    volumes:
      - ./db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U danmuapi -d danmuapi"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 30s
    networks:
      - misaka-net

  danmu-app:
    image: l429609201/misaka_danmu_server:latest
    container_name: misaka-danmu-server
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # è®¾ç½®è¿è¡Œå®¹å™¨çš„ç”¨æˆ·å’Œç»„IDï¼Œä»¥åŒ¹é…æ‚¨å®¿ä¸»æœºçš„ç”¨æˆ·ï¼Œé¿å…æŒ‚è½½å·çš„æƒé™é—®é¢˜ã€‚
      - PUID=1000
      - PGID=1000
      - UMASK=0022
      - TZ=Asia/Shanghai
      # --- æ•°æ®åº“è¿æ¥é…ç½® ---
      - DANMUAPI_DATABASE__TYPE=postgresql                              # æ•°æ®åº“ç±»å‹
      - DANMUAPI_DATABASE__HOST=postgres                                # ä½¿ç”¨æœåŠ¡å
      - DANMUAPI_DATABASE__PORT=5432                                    # æ•°æ®åº“ç«¯å£
      - DANMUAPI_DATABASE__NAME=danmuapi                                # æ•°æ®åº“åç§°
      # !!! é‡è¦ï¼šè¯·ä½¿ç”¨ä¸Šé¢postgreså®¹å™¨ç›¸åŒçš„ç”¨æˆ·åå’Œå¯†ç  !!!
      - DANMUAPI_DATABASE__USER=danmuapi                                # æ•°æ®åº“ç”¨æˆ·å
      - DANMUAPI_DATABASE__PASSWORD=your_strong_postgres_password       # æ•°æ®åº“å¯†ç 
      # --- åˆå§‹ç®¡ç†å‘˜é…ç½® ---
      - DANMUAPI_ADMIN__INITIAL_USER=admin
    volumes:
      - ./config:/app/config
    ports:
      - "7768:7768"

    networks:
      - misaka-net

networks:
  misaka-net:
    driver: bridge
```

## æ­¥éª¤ 2: ä¿®æ”¹é…ç½®å¹¶å¯åŠ¨

1.  **é‡è¦**: æ‰“å¼€æ‚¨åˆšåˆšåˆ›å»ºçš„ `docker-compose.yaml` æ–‡ä»¶ï¼Œå°†æ‰€æœ‰ `your_strong_..._password` æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„å®‰å…¨å¯†ç ã€‚
    -   å¯¹äºMySQLï¼Œæ‚¨éœ€è¦ä¿®æ”¹ `MYSQL_ROOT_PASSWORD`, `MYSQL_PASSWORD` (ä¸¤å¤„) å’Œ `healthcheck` ä¸­çš„å¯†ç ã€‚
    -   å¯¹äºPostgreSQLï¼Œæ‚¨éœ€è¦ä¿®æ”¹ `POSTGRES_PASSWORD` å’Œ `DANMUAPI_DATABASE__PASSWORD`ã€‚

2.  **(å¯é€‰) ä½¿ç”¨ GitHub é•œåƒæº**: å¦‚æœæ‚¨åœ¨æ‹‰å– Docker Hub é•œåƒæ—¶é‡åˆ°ç½‘ç»œé—®é¢˜,å¯ä»¥ä½¿ç”¨ GitHub Container Registry é•œåƒ:

    å°† `docker-compose.yaml` ä¸­çš„é•œåƒåœ°å€:
    ```yaml
    image: l429609201/misaka_danmu_server:latest
    ```

    æ›¿æ¢ä¸º:
    ```yaml
    image: ghcr.io/l429609201/misaka_danmu_server:latest
    ```

3.  åœ¨ `docker-compose.yaml` æ‰€åœ¨ç›®å½•è¿è¡Œå‘½ä»¤å¯åŠ¨åº”ç”¨ï¼š
    ```bash
    docker-compose up -d
    ```

## æ­¥éª¤ 3: è®¿é—®å’Œé…ç½®

- **è®¿é—®Web UI**: æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® `http://<æ‚¨çš„æœåŠ¡å™¨IP>:7768`ã€‚
- **åˆå§‹ç™»å½•**:
  - ç”¨æˆ·å: `admin` (æˆ–æ‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®çš„å€¼)ã€‚
  - å¯†ç : é¦–æ¬¡å¯åŠ¨æ—¶ä¼šåœ¨å®¹å™¨çš„æ—¥å¿—ä¸­ç”Ÿæˆä¸€ä¸ªéšæœºå¯†ç ã€‚è¯·ä½¿ç”¨ `docker logs misaka-danmu-server` æŸ¥çœ‹ã€‚
- **å¼€å§‹ä½¿ç”¨**: ç™»å½•åï¼Œè¯·å…ˆåœ¨ "è®¾ç½®" -> "è´¦æˆ·å®‰å…¨" ä¸­ä¿®æ”¹æ‚¨çš„å¯†ç ï¼Œç„¶åé…ç½®ä»¥ä¸‹å†…å®¹:
  - **å…ƒæ•°æ®æº**: åœ¨ "è®¾ç½®" -> "æœç´¢æº" ä¸­é…ç½® TMDB, TVDB ç­‰ API å¯†é’¥ (å‚è€ƒ [å…ƒæ•°æ®æºé…ç½®æŒ‡å—](å…ƒæ•°æ®æºé…ç½®.md))
  - **AI åŠŸèƒ½** (å¯é€‰): åœ¨ "è®¾ç½®" -> "AI è‡ªåŠ¨åŒ¹é…" ä¸­é…ç½® AI æä¾›å•†å’Œ API Key (å‚è€ƒ [AI åŠŸèƒ½é…ç½®æŒ‡å—](AIåŠŸèƒ½é…ç½®.md))
  - **å¼¹å¹•æº**: åœ¨ "å¼¹å¹•æº" é¡µé¢åŠ è½½æˆ–ä¸Šä¼ å¼¹å¹•æºç¦»çº¿åŒ…

## æ­¥éª¤ 4: ç¯å¢ƒå˜é‡è¯´æ˜

### æ•°æ®åº“é…ç½®

| ç¯å¢ƒå˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
|---------|------|--------|
| `DANMUAPI_DATABASE__TYPE` | æ•°æ®åº“ç±»å‹ (`mysql` æˆ– `postgresql`) | - |
| `DANMUAPI_DATABASE__HOST` | æ•°æ®åº“ä¸»æœºåœ°å€ | - |
| `DANMUAPI_DATABASE__PORT` | æ•°æ®åº“ç«¯å£ | `3306` (MySQL) / `5432` (PostgreSQL) |
| `DANMUAPI_DATABASE__NAME` | æ•°æ®åº“åç§° | - |
| `DANMUAPI_DATABASE__USER` | æ•°æ®åº“ç”¨æˆ·å | - |
| `DANMUAPI_DATABASE__PASSWORD` | æ•°æ®åº“å¯†ç  | - |

### ç®¡ç†å‘˜é…ç½®

| ç¯å¢ƒå˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
|---------|------|--------|
| `DANMUAPI_ADMIN__INITIAL_USER` | åˆå§‹ç®¡ç†å‘˜ç”¨æˆ·å | `admin` |


### å…¶ä»–é…ç½®

| ç¯å¢ƒå˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
|---------|------|--------|
| `PUID` | è¿è¡Œå®¹å™¨çš„ç”¨æˆ· ID | `1000` |
| `PGID` | è¿è¡Œå®¹å™¨çš„ç»„ ID | `1000` |
| `UMASK` | æ–‡ä»¶æƒé™æ©ç  | `0022` |
| `TZ` | æ—¶åŒº | `Asia/Shanghai` |


---

## ğŸ“š ä¸‹ä¸€æ­¥

- **[ğŸ“± å®¢æˆ·ç«¯é…ç½®](å®¢æˆ·ç«¯é…ç½®.md)** - é…ç½®æ’­æ”¾å™¨å¼¹å¹•æ¥å£
- **[ğŸ¬ å…ƒæ•°æ®æºé…ç½®](å…ƒæ•°æ®æºé…ç½®.md)** - é…ç½® TMDB, TVDB ç­‰ API å¯†é’¥
- **[ğŸ¤– AI åŠŸèƒ½é…ç½®](AIåŠŸèƒ½é…ç½®.md)** - é…ç½® AI æ™ºèƒ½åŒ¹é…åŠŸèƒ½
- **[ğŸ”— Webhook é…ç½®](Webhooké…ç½®.md)** - é…ç½® Emby/Jellyfin/Plex è‡ªåŠ¨åŒ–
- **[ğŸ”§ å¼¹å¹•æºç®¡ç†](å¼¹å¹•æºç®¡ç†.md)** - åŠ è½½å’Œç®¡ç†å¼¹å¹•æº
