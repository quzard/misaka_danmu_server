# 🎬 弹幕功能配置指南

本文档详细介绍 Web UI 中"弹幕"页面下的所有功能模块和配置项。

## 📋 目录

1. [Token管理](#token管理)
2. [弹幕输出控制](#弹幕输出控制)
3. [弹幕存储配置](#弹幕存储配置)
4. [设置](#设置)
   - [匹配后备](#匹配后备)
   - [后备搜索](#后备搜索)
   - [顺延机制](#顺延机制)
   - [预下载](#预下载)
   - [匹配后备Token授权](#匹配后备token授权)
   - [匹配后备黑名单](#匹配后备黑名单)

---

## Token管理

**功能说明**: 管理API访问令牌,用于控制第三方应用对弹幕API的访问权限。

### 创建Token

**操作步骤**:
1. 点击"创建Token"按钮
2. 输入Token名称(用于识别)
3. 设置有效期:
   - 输入天数(如 30、90、365)
   - 或选择"永久有效"
4. 设置每日调用限制(可选)
5. 点击"确认"创建

**Token格式**: 系统自动生成20位随机字符串(包含大小写字母和数字)

### 管理Token

**功能**:
- 查看Token列表: 显示所有已创建的Token及其状态
- 复制Token: 点击复制按钮快速复制Token字符串
- 删除Token: 删除不再使用的Token
- 查看统计: 查看Token的调用次数和有效期

**使用场景**:
- 为不同的播放器客户端分配独立Token
- 为第三方应用提供API访问权限
- 限制单个Token的调用频率

---

## 弹幕输出控制

**功能说明**: 调整弹幕API的输出行为,优化客户端性能。

### 弹幕输出上限

**配置项**: `弹幕输出上限`

**说明**: 设置弹幕API返回的弹幕最大数量。

**配置值**:
- `-1`: 无限制,返回所有弹幕
- `正整数`: 限制返回的弹幕数量(建议 3000-5000)

**工作原理**:
- 当弹幕总数超过限制时,系统会按时间段均匀采样
- 确保弹幕在整个视频时长中分布均匀
- 避免客户端因弹幕过多而卡顿

**推荐配置**:
- 移动设备: 3000
- 桌面设备: 5000
- 高性能设备: 8000 或更高

---

## 弹幕存储配置

**功能说明**: 自定义弹幕文件的存储路径和命名规则。

### 启用自定义路径

**配置项**: `启用自定义弹幕路径`

**说明**: 开启后,可以自定义弹幕文件的存储位置和命名模板。

### 电影弹幕配置

**配置项**:
- `电影弹幕目录路径`: 电影弹幕的存储根目录
- `电影弹幕文件名模板`: 电影弹幕文件的命名规则

**默认配置**:
```
目录路径: /app/config/danmaku/movies
文件名模板: ${title}/${episodeId}
```

**支持的变量**:
- `${title}`: 电影标题
- `${year}`: 上映年份
- `${provider}`: 弹幕源提供商
- `${animeId}`: 作品ID
- `${episodeId}`: 分集ID
- `${sourceId}`: 源ID

**示例**:
```
模板: ${title}/${episodeId}
结果: /app/config/danmaku/movies/肖申克的救赎/12345.xml

模板: ${title} (${year})/${provider}_${episodeId}
结果: /app/config/danmaku/movies/肖申克的救赎 (1994)/dandanplay_12345.xml
```

### 电视节目弹幕配置

**配置项**:
- `电视弹幕目录路径`: 电视节目弹幕的存储根目录
- `电视弹幕文件名模板`: 电视节目弹幕文件的命名规则

**默认配置**:
```
目录路径: /app/config/danmaku/tv
文件名模板: ${animeId}/${episodeId}
```

**支持的变量**: 同电影配置

**示例**:
```
模板: ${animeId}/${episodeId}
结果: /app/config/danmaku/tv/67890/12345.xml

模板: ${title}/S${season}E${episode}
结果: /app/config/danmaku/tv/权力的游戏/S01E01.xml
```

### 路径预览

**功能**: 实时预览当前配置生成的文件路径

**说明**: 在修改配置时,系统会自动显示示例路径,帮助您验证配置是否正确。

---

## 设置

**功能说明**: 配置弹幕搜索、匹配、导入等高级功能。


### 顺延机制

**配置项**: `启用顺延机制`

**功能说明**: 当选中的弹幕源没有有效分集时(如只有预告片被过滤掉),自动尝试下一个候选源,提高导入成功率。

**工作原理**:
1. 系统从搜索结果中选择最佳匹配源
2. 检查该源是否有有效分集(过滤预告片等无效内容)
3. 如果没有有效分集,自动尝试下一个候选源
4. 重复步骤2-3,直到找到有效源或尝试完所有候选源

**传统模式 vs 顺延模式**:

| 模式 | 行为 | 适用场景 |
|------|------|----------|
| 传统模式 | 只尝试第一个匹配源,失败则结束 | 搜索源质量稳定,很少出现无效分集 |
| 顺延模式 | 自动尝试多个候选源,直到成功 | 搜索源质量不稳定,经常出现无效分集 |

**适用场景**:
- 某些搜索源只有预告片或特典
- 提高自动导入的成功率
- 减少手动重试的次数

**依赖条件**:
- 需要启用"匹配后备"或"后备搜索"
- 如果两者都未启用,此选项将被禁用

**注意事项**:
- 顺延机制会增加导入时间
- 建议配置多个高质量搜索源

### 预下载

**配置项**: `启用预下载`

**功能说明**: 当播放当前集时,系统会自动在后台下载下一集的弹幕(如果下一集存在且没有弹幕)。

**工作原理**:
1. 播放器请求当前集的弹幕(如 S01E01)
2. 系统检查下一集(S01E02)是否存在
3. 如果下一集存在但没有弹幕,触发后台下载任务
4. 系统使用匹配后备或后备搜索机制下载下一集弹幕
5. 下载完成后,用户播放下一集时弹幕已准备就绪

**优势**:
- 提升观看体验: 播放下一集时弹幕已准备好
- 减少等待时间: 无需等待弹幕下载
- 无感知下载: 后台自动完成,不影响当前播放

**适用场景**:
- 连续播放电视剧
- 追番时自动获取最新集弹幕
- 减少手动操作

**依赖条件**:
- 需要启用"匹配后备"或"后备搜索"
- 如果两者都未启用,此选项将被禁用

**注意事项**:
- 预下载是异步任务,不会阻塞当前播放
- 只下载下一集,不会批量下载整季
- 如果下一集已有弹幕,不会重复下载

### 匹配后备Token授权

**功能说明**: 为匹配后备功能配置专用的API Token,用于访问第三方弹幕源。

**配置项**:
- `Token列表`: 添加多个Token,系统会自动轮换使用
- `Token状态`: 显示每个Token的可用状态和剩余配额

**使用场景**:
- 某些弹幕源需要API Token才能访问
- 提高API调用限额(多个Token轮换使用)
- 避免单个Token被限流

**配置步骤**:
1. 从弹幕源获取API Token
2. 在此处添加Token
3. 系统自动验证Token有效性
4. 匹配后备功能会自动使用这些Token

**Token管理**:
- 添加Token: 输入Token字符串并保存
- 删除Token: 移除不再使用的Token
- 查看状态: 实时显示Token的可用状态

**注意事项**:
- 不同的弹幕源可能需要不同的Token
- 建议配置多个Token以提高可用性
- 定期检查Token是否过期

### 匹配后备黑名单

**功能说明**: 配置匹配后备功能的黑名单,阻止特定作品或源被自动导入。

**配置项**:
- `作品黑名单`: 阻止特定作品的弹幕被自动导入
- `源黑名单`: 阻止特定弹幕源的内容被自动导入

**使用场景**:
- 某些作品的弹幕质量差,不希望自动导入
- 某些弹幕源经常匹配错误,需要屏蔽
- 避免导入不需要的内容

**配置方式**:

**作品黑名单**:
```
格式: 作品名称(每行一个)
示例:
作品A
作品B
作品C
```

**源黑名单**:
```
格式: 源名称(每行一个)
示例:
dandanplay
bilibili
某个低质量源
```

**工作原理**:
1. 匹配后备功能搜索到结果
2. 系统检查结果是否在黑名单中
3. 如果在黑名单中,跳过该结果
4. 继续尝试下一个候选结果

**注意事项**:
- 黑名单匹配是精确匹配,不支持模糊匹配
- 黑名单会影响所有自动导入功能
- 建议定期清理不再需要的黑名单项

---

## 配置建议

### 推荐配置组合

**场景1: 自动化程度最高**
```
✅ 启用匹配后备
✅ 启用后备搜索
✅ 启用顺延机制
✅ 启用预下载
✅ 配置多个搜索源
✅ 启用AI匹配
```
**适用**: 追求最佳用户体验,希望完全自动化

**场景2: 平衡模式**
```
✅ 启用匹配后备
✅ 启用后备搜索
❌ 禁用顺延机制
✅ 启用预下载
✅ 配置2-3个高质量搜索源
```
**适用**: 平衡自动化和性能

**场景3: 手动控制**
```
❌ 禁用匹配后备
✅ 启用后备搜索
❌ 禁用顺延机制
❌ 禁用预下载
✅ 配置1-2个搜索源
```
**适用**: 希望手动选择弹幕源,完全控制导入过程

### 性能优化建议

**弹幕输出上限**:
- 移动设备: 3000
- 桌面设备: 5000
- 高性能设备: 8000

**搜索源配置**:
- 启用2-3个高质量搜索源
- 禁用低质量或不稳定的源
- 定期检查源的可用性

**Token配置**:
- 配置2-3个Token轮换使用
- 定期检查Token是否过期
- 避免单个Token被限流

---

## 常见问题

### Q: 匹配后备和后备搜索有什么区别?

A:
- **匹配后备**: 播放器使用 `/match` 接口时触发,自动匹配并导入弹幕
- **后备搜索**: 播放器使用 `/search/anime` 接口时触发,返回搜索结果供用户选择

### Q: 为什么顺延机制和预下载被禁用?

A: 这两个功能依赖于"匹配后备"或"后备搜索"。如果两者都未启用,这两个功能将被禁用。

### Q: 如何提高匹配准确率?

A: 建议:
1. 启用AI匹配功能
2. 配置多个元数据源(TMDB、TVDB、Bangumi等)
3. 使用标准的文件命名格式
4. 为常用作品添加精确标记

### Q: 预下载会影响性能吗?

A: 不会。预下载是异步后台任务,不会阻塞当前播放或影响系统性能。

### Q: 如何查看匹配后备任务的执行状态?

A: 可以在"Webhook"页面的"任务列表"中查看所有后台任务的执行状态,包括匹配后备任务。

---

## 相关文档

- [快速开始](快速开始.md)
- [元数据源配置](元数据源配置.md)
- [AI功能配置](AI功能配置.md)
- [弹幕源管理](弹幕源管理.md)
- [Webhook配置](Webhook配置.md)

